name: Continuous Deployment

on:
  workflow_run:
    workflows: ["CI.yml Continuous Integration"]
    types:
      - completed

jobs:
  check_branch:
    runs-on: ubuntu-latest
    outputs:
      is_main: ${{ steps.check.outputs.is_main }}
    steps:
      - id: check
        run: echo "::set-output name=is_main::${{ github.event.workflow_run.head_branch == 'main' }}"
        
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Pack NuGet Package
      run: cd ./RustPlusApi/RustPlusApi/ && dotnet pack --configuration Release

    - name: Upload a Build Artifact
      uses: actions/upload-artifact@v3.1.0
      with:
        path: ./**/*.nupkg

    - name: Publish NuGet Package to GitHub Packages
      run: dotnet nuget push ./**/*.nupkg --api-key ${{secrets.GITHUB_TOKEN}} --source https://nuget.pkg.github.com/${{github.repository_owner}}/index.json

    - name: Publish NuGet Package
      run: dotnet nuget push ./**/*.nupkg --api-key ${{secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json
